<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slippi Profile Display</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      text-align: center;
      background-color: #121212;
      color: #ffffff;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background-color: #121212;
      padding: 20px;
      border: 1px solid #555;
      border-radius: 5px;
      box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.7);
    }
    .card {
      border: 1px solid #555;
      border-radius: 5px;
      padding: 15px;
      margin: 15px 0;
      background-color: #121212;
      box-shadow: 0px 8px 20px rgba(0,0,0,0.7);
    }
    h1, h2 {
      margin-top: 0;
    }
    .characters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }
    .character {
      display: flex;
      align-items: center;
      background-color: #222;
      padding: 5px 10px;
      margin: 5px;
      border-radius: 3px;
      font-size: 0.9em;
    }
    .character img {
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
    p {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Slippi Profile: DMAR#554</h1>
    <div id="profile"></div>
  </div>

  <script>
    // GraphQL endpoint and payload (for user DMAR#554)
    const endpoint = "https://gql-gateway-2-dot-slippi.uc.r.appspot.com/graphql";
    const payload = {
      operationName: "AccountManagementPageQuery",
      query: `fragment profileFieldsV2 on NetplayProfileV2 {
  id
  ratingOrdinal
  ratingUpdateCount
  wins
  losses
  dailyGlobalPlacement
  dailyRegionalPlacement
  continent
  characters {
    character
    gameCount
    __typename
  }
  __typename
}

fragment userProfilePage on User {
  fbUid
  displayName
  connectCode {
    code
    __typename
  }
  status
  activeSubscription {
    level
    hasGiftSub
    __typename
  }
  rankedNetplayProfile {
    ...profileFieldsV2
    __typename
  }
  rankedNetplayProfileHistory {
    ...profileFieldsV2
    season {
      id
      startedAt
      endedAt
      name
      status
      __typename
    }
    __typename
  }
  __typename
}

query AccountManagementPageQuery($cc: String!, $uid: String!) {
  getUser(fbUid: $uid) {
    ...userProfilePage
    __typename
  }
  getConnectCode(code: $cc) {
    user {
      ...userProfilePage
      __typename
    }
    __typename
  }
}`,
      variables: { cc: "DMAR#554", uid: "DMAR#554" }
    };

    // New helper: Format any all-caps, underscore-separated string into a user-friendly format.
    function formatResponseData(text) {
      if (typeof text !== 'string') return text;
      return text
        .toLowerCase()
        .split('_')
        .map(word => {
          // If the word contains digits, leave them attached to the word.
          return word.charAt(0).toUpperCase() + word.slice(1);
        })
        .join(' ');
    }

    // Helper: Get the icon filename based on the API character name.
    // Converts name to lowercase and replaces underscores with hyphens.
    function getCharacterIcon(apiName) {
      return `icons/${apiName.toLowerCase().replace(/_/g, "-")}.png`;
    }

    // Helper function to create a card element with a title and content
    function createCard(title, contentHTML) {
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('h2');
      header.textContent = title;
      card.appendChild(header);
      const contentDiv = document.createElement('div');
      contentDiv.innerHTML = contentHTML;
      card.appendChild(contentDiv);
      return card;
    }

    // Function to render the user profile data
    function renderUserProfile(user) {
      const profileContainer = document.getElementById('profile');
      if (!user) {
        profileContainer.textContent = 'No user data found.';
        return;
      }

      // Basic Information
      let basicHTML = `
        <p><strong>Name:</strong> ${user.displayName}</p>
        <p><strong>Connect Code:</strong> ${user.connectCode.code}</p>
        <p><strong>Status:</strong> ${formatResponseData(user.status)}</p>
        <p><strong>Subscription:</strong> ${formatResponseData(user.activeSubscription.level)} ${user.activeSubscription.hasGiftSub ? '(Gifted)' : ''}</p>
      `;
      profileContainer.appendChild(createCard("Basic Information", basicHTML));

      // Ranked Netplay Profile
      if (user.rankedNetplayProfile) {
        let profile = user.rankedNetplayProfile;
        let profileHTML = `
          <p><strong>Rating:</strong> ${profile.ratingOrdinal.toFixed(2)}</p>
          <p><strong>Rating Updates:</strong> ${profile.ratingUpdateCount}</p>
          <p><strong>Wins:</strong> ${profile.wins}</p>
          <p><strong>Losses:</strong> ${profile.losses}</p>
          <p><strong>Continent:</strong> ${formatResponseData(profile.continent)}</p>
        `;
        // List characters used
        if (profile.characters && profile.characters.length > 0) {
          profileHTML += `<h3>Characters</h3><div class="characters">`;
          profile.characters.forEach(char => {
            const displayName = formatResponseData(char.character);
            const iconPath = getCharacterIcon(char.character);
            profileHTML += `<div class="character">
              <img src="${iconPath}" alt="${displayName} icon" onerror="this.style.display='none'">
              ${displayName}: ${char.gameCount} games
            </div>`;
          });
          profileHTML += `</div>`;
        }
        profileContainer.appendChild(createCard("Ranked Netplay Profile", profileHTML));
      }

      // Ranked Netplay Profile History
      if (user.rankedNetplayProfileHistory && user.rankedNetplayProfileHistory.length > 0) {
        user.rankedNetplayProfileHistory.forEach(history => {
          let season = history.season;
          let historyHTML = `
            <p><strong>Season:</strong> ${season.name} (${formatResponseData(season.status)})</p>
            <p><strong>Period:</strong> ${new Date(season.startedAt).toLocaleDateString()} - ${new Date(season.endedAt).toLocaleDateString()}</p>
            <p><strong>Rating:</strong> ${history.ratingOrdinal.toFixed(2)}</p>
            <p><strong>Rating Updates:</strong> ${history.ratingUpdateCount}</p>
            <p><strong>Wins:</strong> ${history.wins}</p>
            <p><strong>Losses:</strong> ${history.losses}</p>
            <p><strong>Continent:</strong> ${formatResponseData(history.continent)}</p>
          `;
          // List characters used in this season
          if (history.characters && history.characters.length > 0) {
            historyHTML += `<h4>Characters</h4><div class="characters">`;
            history.characters.forEach(char => {
              const displayName = formatResponseData(char.character);
              const iconPath = getCharacterIcon(char.character);
              historyHTML += `<div class="character">
                <img src="${iconPath}" alt="${displayName} icon" onerror="this.style.display='none'">
                ${displayName}: ${char.gameCount} games
              </div>`;
            });
            historyHTML += `</div>`;
          }
          profileContainer.appendChild(createCard(`Ranked Netplay History - ${season.name}`, historyHTML));
        });
      }
    }

    // Fetch data and render it on the page
    fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
      .then(response => response.json())
      .then(data => {
        // Use getUser if available, otherwise fallback to getConnectCode.user
        const user = data.data.getUser || (data.data.getConnectCode && data.data.getConnectCode.user);
        renderUserProfile(user);
      })
      .catch(error => {
        document.getElementById('profile').textContent = 'Error: ' + error;
      });
  </script>
</body>
</html>
