<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .tab { display: inline-block; padding: 10px; cursor: pointer; }
        .tab-content { display: none; }
        .active { display: block; }
        .hidden { display: none; }
        .gray { color: gray; }
        canvas { max-width: 800px; margin: auto; }
    </style>
</head>
<body>
    <h1>Leaderboard</h1>
    <div>
        <span class="tab" onclick="showTab('leaderboard')">Leaderboard</span>
        <span class="tab" onclick="showTab('record-progress')">Record Progress</span>
        <span class="tab" onclick="showTab('personal-best')">Personal Bests</span>
    </div>
    
    <div id="leaderboard" class="tab-content active">
        <label><input type="checkbox" id="toggleObsolete" checked> Show Obsoleted Runs</label>
        <table border="1" style="margin:auto;">
            <thead>
                <tr><th>Rank</th><th>Player</th><th>Score</th></tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>
    
    <div id="record-progress" class="tab-content">
        <canvas id="recordChart"></canvas>
    </div>
    
    <div id="personal-best" class="tab-content">
        <canvas id="personalBestChart"></canvas>
    </div>

    <script>
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        async function fetchLeaderboardData() {
            try {
                const response = await fetch('leaderboard.json');
                const data = await response.json();
                processAndRenderData(data.runs);
            } catch (error) {
                console.error("Error loading leaderboard data:", error);
            }
        }

        function processAndRenderData(runs) {
            const latestBest = {};
            const obsoletedRuns = new Set();
            let recordProgress = [];
            let personalBests = {};

            runs.sort((a, b) => new Date(a.date) - new Date(b.date));
            let highestScore = 0;

            runs.forEach(run => {
                if (!latestBest[run.player] || run.score > latestBest[run.player]) {
                    latestBest[run.player] = run.score;
                }
                if (run.score < latestBest[run.player]) {
                    obsoletedRuns.add(run);
                }
                if (run.score > highestScore) {
                    highestScore = run.score;
                    recordProgress.push({ date: run.date, score: run.score });
                }
                if (!personalBests[run.player]) {
                    personalBests[run.player] = [];
                }
                personalBests[run.player].push({ date: run.date, score: run.score });
            });

            renderLeaderboard(runs, obsoletedRuns);
            renderRecordProgressChart(recordProgress);
            renderPersonalBestChart(personalBests);
        }

        function renderLeaderboard(runs, obsoletedRuns) {
            let tbody = document.getElementById("leaderboard-body");
            tbody.innerHTML = "";
            runs.sort((a, b) => b.score - a.score).forEach(run => {
                let row = `<tr class="${obsoletedRuns.has(run) ? 'gray obsolete' : ''}"><td></td><td>${run.player}</td><td>${run.score}</td></tr>`;
                tbody.innerHTML += row;
            });
            updateRanks();
        }

        function updateRanks() {
            let rows = document.querySelectorAll("#leaderboard-body tr");
            let rank = 1;
            rows.forEach(row => {
                if (!row.classList.contains('hidden')) {
                    row.cells[0].innerText = rank++;
                }
            });
        }

        function renderRecordProgressChart(recordProgress) {
            new Chart(document.getElementById("recordChart"), {
                type: 'line',
                data: {
                    labels: recordProgress.map(r => r.date),
                    datasets: [{
                        label: "Record Progression",
                        data: recordProgress.map(r => r.score),
                        borderColor: "blue",
                        fill: false
                    }]
                },
                options: { responsive: true }
            });
        }

        function renderPersonalBestChart(personalBests) {
            let datasets = Object.keys(personalBests).map(player => ({
                label: player,
                data: personalBests[player].map(r => ({ x: r.date, y: r.score })),
                borderColor: getRandomColor(),
                fill: false
            }));
            
            new Chart(document.getElementById("personalBestChart"), {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true } },
                    scales: { x: { type: 'time', time: { unit: 'month' } } }
                }
            });
        }

        function getRandomColor() {
            return `hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`;
        }

        document.getElementById("toggleObsolete").addEventListener("change", function() {
            document.querySelectorAll(".obsolete").forEach(row => {
                row.classList.toggle("hidden", !this.checked);
            });
            updateRanks();
        });

        fetchLeaderboardData();
    </script>
</body>
</html>
